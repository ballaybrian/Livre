<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#F2B8C6" />
  <title>Books By Siana</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#50514D;
      --pink:#F2B8C6;
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --panel: rgba(0,0,0,.16);
      --border: rgba(255,255,255,.16);
      --shadow: 0 14px 34px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --w: 1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:var(--w); margin:0 auto; padding:18px}
    .view{display:none}
    .view.active{display:block}

    .brand-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 8px 0 18px;
      text-align:center;
    }
    .brand-center img{
      width:70px; height:70px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
    }
    .brand-center .name{
      font-weight:1000;
      font-size:20px;
      color: var(--pink);
      letter-spacing:.2px;
    }
    .brand-center .sub{
      font-size:12px;
      color: var(--muted);
      margin-top:-4px;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background: var(--pink);
      color:#2a2a2a;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:9px 11px; font-size:13px}
    .btn.danger{
      background: rgba(239,68,68,.92);
      color:#fff;
    }

    .panel{
      margin-top:12px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      padding:14px 16px;
      font-size:13px;
      color: var(--muted);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .content{padding:14px 16px}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    .input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:100px; resize: vertical}
    .hint{color: var(--muted); font-size:12px; margin-top:8px; line-height:1.35}

    .home{
      margin-top:8px;
      min-height: calc(100vh - 200px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 26px;
    }
    .home-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap:18px;
      width:100%;
      max-width:520px;
    }
    .home-btn{
      position:relative;
      padding:26px 18px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .08s ease, background .2s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .home-btn:hover{transform: translateY(-2px); background: rgba(0,0,0,.24)}
    .home-btn b{font-size:14px; letter-spacing:.3px; color: var(--pink); margin-top:4px}
    .badge{
      position:absolute;
      top:10px; right:10px;
      min-width:34px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      font-weight:900;
      font-size:12px;
      color:#fff;
      text-align:center;
    }

    .ico{width:42px;height:42px;display:block}
    .ico.small{width:18px;height:18px}
    .ico path, .ico circle, .ico rect, .ico line, .ico polyline{stroke: var(--pink)}

    .list{
      display:grid;
      grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      padding:12px;
      display:flex;
      gap:12px;
      cursor:pointer;
      transition: transform .06s ease;
    }
    .card:hover{transform: translateY(-1px)}

    .cover{
      width:52px;
      height:78px;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:900;
      color: rgba(255,255,255,.7);
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}

    .meta{min-width:0; flex:1}
    .meta .t{margin:0 0 4px 0; font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta .a{margin:0 0 8px 0; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(242,184,198,.65);
      background: var(--pink);
      color:#2a2a2a;
      font-size:12px;
      font-weight:1000;
      user-select:none;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      text-decoration:none;
      white-space:nowrap;
    }
    .chip.danger{
      background: rgba(239,68,68,.92);
      border-color: rgba(239,68,68,.55);
      color:#fff;
    }
    .empty{padding: 22px 16px; color: var(--muted); text-align:center; font-size:13px}

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(30,30,30,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .modal .mhead b{color: var(--pink)}
    .modal .body{
      padding: 14px 16px 18px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 14px;
    }
    .bigcover{
      width:160px; height:230px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bigcover img{width:100%; height:100%; object-fit:cover; display:block}
    .desc{color:#fff; line-height:1.45; font-size:14px; white-space: pre-wrap}
    .mfoot{
      border-top:1px solid var(--border);
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    @media (max-width:720px){
      .home-grid{grid-template-columns: 1fr; max-width: 420px;}
      .modal .body{grid-template-columns: 1fr;}
      .bigcover{width:100%; height:320px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="view-login" class="view"></div>
    <div id="view-home" class="view active"></div>
    <div id="view-ebooks" class="view"></div>
    <div id="view-wishlist" class="view"></div>
    <div id="view-pal" class="view"></div>
    <div id="view-read" class="view"></div>
    <div id="view-add" class="view"></div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mhead">
        <div>
          <b id="modalTitle">‚Äî</b>
          <div id="modalAuthor" style="color:rgba(255,255,255,.78);font-size:12px;margin-top:2px">‚Äî</div>
        </div>
        <button class="btn small" id="modalClose">Fermer</button>
      </div>

      <div class="body">
        <div class="bigcover" id="modalCover"></div>
        <div>
          <div class="desc" id="modalDesc"></div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap" id="modalBadges"></div>
        </div>
      </div>

      <div class="mfoot">
        <a class="btn small" id="modalAmazon" target="_blank" rel="noopener">Amazon</a>
        <button class="btn danger small" id="modalDelete">Supprimer</button>
      </div>
    </div>
  </div>

<script>
/* Books By Siana - v9 (Local accounts PIN 4 digits + per-user save + edition + better search) */

/* ========= Accounts / Storage ========= */
const APP_NS = "bbs";
const LEGACY_KEYS = ["bbs.books.v6", "bbs.books.v7", "bbs.books.v8", "bbs.books.v9"];
let currentUser = loadCurrentUser(); // { username, pinHash } or null
let state = { books: [], __meta: {} };
let currentRoute = "home";

function safeUsername(u){
  return String(u || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^a-z0-9_\-]/g, "")
    .slice(0, 24);
}
function isValidPin(pin){
  return /^[0-9]{4}$/.test(String(pin || ""));
}
function hashPin(pin){
  // Light local hash (not crypto) ‚Äì enough to separate users on one device
  const s = String(pin || "");
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16);
}
function userKey(username){ return `${APP_NS}:user:${username}`; }
function sessionKey(){ return `${APP_NS}:session`; }

function loadCurrentUser(){
  try{
    const raw = localStorage.getItem(sessionKey());
    if(!raw) return null;
    const u = JSON.parse(raw);
    if(!u?.username || !u?.pinHash) return null;
    return u;
  }catch{ return null; }
}
function saveCurrentUser(user){
  localStorage.setItem(sessionKey(), JSON.stringify(user));
}
function loadUserState(username){
  try{
    const raw = localStorage.getItem(userKey(username));
    if(raw){
      const parsed = JSON.parse(raw);
      if(parsed?.books) return parsed;
    }
  }catch{}

  // Migration: try to recover legacy data (first time user logs in)
  for(const k of LEGACY_KEYS){
    try{
      const legacy = localStorage.getItem(k);
      if(!legacy) continue;
      const parsed = JSON.parse(legacy);
      if(parsed?.books?.length){
        return { books: parsed.books, __meta: { migratedFrom: k, migratedAt: Date.now() } };
      }
    }catch{}
  }
  return { books: [], __meta: {} };
}
function saveUserState(username, data){
  localStorage.setItem(userKey(username), JSON.stringify(data));
}
function saveState(){
  if(!currentUser) return;
  saveUserState(currentUser.username, state);
}
function setActiveUser(username, pin){
  const u = safeUsername(username);
  if(!u) throw new Error("Pseudo invalide");
  if(!isValidPin(pin)) throw new Error("PIN invalide (4 chiffres)");

  const pinHash = hashPin(pin);

  // If user exists, check PIN
  const existingRaw = localStorage.getItem(userKey(u));
  if(existingRaw){
    const existing = JSON.parse(existingRaw);
    const meta = existing?.__meta || {};
    if(meta.pinHash && meta.pinHash !== pinHash){
      throw new Error("Code PIN incorrect");
    }
    currentUser = { username: u, pinHash };
    saveCurrentUser(currentUser);
    state = existing?.books ? existing : { books: [] };
    state.__meta = state.__meta || {};
    state.__meta.pinHash = pinHash;
    state.__meta.lastLoginAt = Date.now();
    saveState();
    return;
  }

  // New user
  currentUser = { username: u, pinHash };
  saveCurrentUser(currentUser);
  state = { books: [], __meta: { pinHash, createdAt: Date.now(), lastLoginAt: Date.now() } };
  saveState();
}
function logout(){
  localStorage.removeItem(sessionKey());
  currentUser = null;
  state = { books: [], __meta: {} };
}

/* ========= Utils ========= */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function toAuthorsDisplay(authors){
  if(!authors || !authors.length) return "Auteur inconnu";
  return authors.join(", ");
}
function formatFormatLabel(book){ return book.format === "ebook" ? "Ebook" : "Wishlist"; }
function formatIconFallback(book){ return book.format === "ebook" ? "üì±" : "‚ù§"; }

/* ===== Edition helpers ===== */
function editionLabel(edition){
  if(edition === "poche") return "Poche";
  if(edition === "broche") return "Broch√©";
  return "";
}
function applyEditionToQuery(query, edition){
  if (String(query).startsWith("isbn:")) return query;
  if (edition === "poche") return `${query} poche`;
  if (edition === "broche") return `${query} broch√©`;
  return query;
}

/* ===== Amazon link builder ===== */
function amazonSearchUrl(bookOrTitle, authors){
  let title = "";
  let author = "";
  let edition = "";
  if(typeof bookOrTitle === "string"){
    title = bookOrTitle;
    author = (authors && authors.length) ? authors[0] : "";
  }else{
    title = bookOrTitle?.title || "";
    author = (bookOrTitle?.authors && bookOrTitle.authors.length) ? bookOrTitle.authors[0] : "";
    edition = editionLabel(bookOrTitle?.edition || "");
  }
  const q = `${title} ${author} ${edition}`.trim();
  return "https://www.amazon.fr/s?k=" + encodeURIComponent(q);
}

/* ===== SVG ICONS ===== */
function svgReader(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="7" y="2.8" width="10" height="18.4" rx="2.2"></rect>
      <line x1="9" y1="6" x2="15" y2="6"></line>
      <circle cx="12" cy="18" r="0.9" fill="none"></circle>
    </svg>
  `;
}
function svgHeart(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M20.4 4.9c-1.6-1.7-4.2-1.7-5.8 0L12 7.5 9.4 4.9c-1.6-1.7-4.2-1.7-5.8 0-1.8 1.9-1.7 4.9.2 6.7L12 20l8.2-8.4c1.9-1.8 2-4.8.2-6.7z"></path>
    </svg>
  `;
}
function svgOpenBook(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 19c-2.2-1.5-5.2-2.2-8-2V6c2.8-.2 5.8.6 8 2"></path>
      <path d="M12 19c2.2-1.5 5.2-2.2 8-2V6c-2.8-.2-5.8.6-8 2"></path>
      <line x1="12" y1="8" x2="12" y2="19"></line>
    </svg>
  `;
}
function svgClosedBook(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M7 3h10a2 2 0 0 1 2 2v15a1.5 1.5 0 0 1-1.5 1.5H8.5A1.5 1.5 0 0 1 7 20V3z"></path>
      <line x1="9" y1="7" x2="15" y2="7"></line>
      <line x1="9" y1="11" x2="15" y2="11"></line>
      <line x1="7" y1="20" x2="19" y2="20"></line>
    </svg>
  `;
}

/* ========= Routing ========= */
function show(route){
  if(!currentUser && route !== "login") route = "login";
  currentRoute = route;

  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("view-"+route).classList.add("active");

  if(route === "login") renderLogin();
  if(route === "home") renderHome();
  if(route === "ebooks") renderList("ebooks");
  if(route === "wishlist") renderList("wishlist");
  if(route === "pal") renderPAL();
  if(route === "read") renderRead();
  if(route === "add") renderAdd();
}
function backToHome(){ show("home"); }

function brandCenter(subtitle){
  const who = currentUser ? `‚Ä¢ ${escapeHtml(currentUser.username)}` : "";
  return `
    <div class="brand-center">
      <img src="./bbs-logo.png" alt="BBS">
      <div class="name">Books By Siana</div>
      <div class="sub">${escapeHtml(subtitle)} ${who}</div>
    </div>
  `;
}

/* ========= Login ========= */
function renderLogin(){
  const root = document.getElementById("view-login");
  root.innerHTML = `
    ${brandCenter("Connexion")}
    <div class="panel">
      <h2><span>Se connecter / Cr√©er un compte</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="lgUser" placeholder="Pseudo (ex: siana)" autocomplete="username" />
          <input class="input" id="lgPin" placeholder="PIN (4 chiffres)" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="current-password" />
        </div>
        <div class="row" style="margin-top:10px; justify-content:center">
          <button class="btn" id="lgBtn">Connexion</button>
        </div>
        <div class="hint" id="lgMsg"></div>
      </div>
    </div>
  `;

  const uEl = root.querySelector("#lgUser");
  const pEl = root.querySelector("#lgPin");
  const msg = root.querySelector("#lgMsg");

  pEl.addEventListener("input", ()=>{
    pEl.value = pEl.value.replace(/[^0-9]/g, "").slice(0,4);
  });

  root.querySelector("#lgBtn").onclick = ()=>{
    msg.textContent = "";
    try{
      setActiveUser(uEl.value, pEl.value);
      show("home");
    }catch(e){
      msg.textContent = e.message || "Erreur";
    }
  };
}

/* ========= Backup ========= */
function exportBackup(){
  if(!currentUser) return;
  const payload = {
    app: "BooksBySiana",
    version: 1,
    username: currentUser.username,
    exportedAt: new Date().toISOString(),
    data: state
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `bbs-backup-${currentUser.username}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importBackup(file){
  if(!currentUser) return;
  const text = await file.text();
  const payload = JSON.parse(text);
  if(!payload?.data?.books) throw new Error("Fichier invalide");
  state = payload.data;
  state.__meta = state.__meta || {};
  state.__meta.pinHash = currentUser.pinHash;
  saveState();
  show("home");
}

/* ========= Stats ========= */
function getStats(){
  const books = state.books || [];
  const ebooks = books.filter(b => b.format === "ebook" && !b.read && !b.acquired).length;
  const wishlist = books.filter(b => b.format === "wishlist" && !b.read && !b.acquired).length;
  const pal = books.filter(b => !b.read && b.acquired).length;
  const read = books.filter(b => b.read).length;
  return { ebooks, wishlist, pal, read };
}

/* ========= HOME ========= */
function renderHome(){
  const root = document.getElementById("view-home");
  const s = getStats();

  root.innerHTML = `
    ${brandCenter("Accueil")}
    <div class="home">
      <div style="width:100%">
        <div class="home-grid">
          <div class="home-btn" id="goEbooks">
            <div class="badge">${s.ebooks}</div>
            ${svgReader("")}
            <b>Ebooks</b>
          </div>

          <div class="home-btn" id="goWishlist">
            <div class="badge">${s.wishlist}</div>
            ${svgHeart("")}
            <b>Wishlist</b>
          </div>

          <div class="home-btn" id="goPAL">
            <div class="badge">${s.pal}</div>
            ${svgOpenBook("")}
            <b>PAL</b>
          </div>

          <div class="home-btn" id="goRead">
            <div class="badge">${s.read}</div>
            ${svgClosedBook("")}
            <b>Livres Lus</b>
          </div>

          <div class="home-btn" id="goAdd" style="grid-column: 1 / -1;">
            <div class="badge">+</div>
            <div style="font-size:34px; font-weight:1000; color: var(--pink); line-height:1">+</div>
            <b>Ajouter un livre</b>
          </div>
        </div>

        <div class="row" style="justify-content:center; margin-top:12px">
          <button class="btn small" id="btnExport">Exporter</button>
          <label class="btn small" style="cursor:pointer">
            Importer<input type="file" id="btnImport" accept="application/json" style="display:none">
          </label>
          <button class="btn small danger" id="btnLogout">D√©connexion</button>
        </div>

        <div class="hint" style="text-align:center; margin-top:10px">
          Donn√©es sauvegard√©es <b>sur cet appareil</b> pour <b>${escapeHtml(currentUser.username)}</b>.
        </div>
      </div>
    </div>
  `;

  root.querySelector("#goEbooks").onclick = ()=> show("ebooks");
  root.querySelector("#goWishlist").onclick = ()=> show("wishlist");
  root.querySelector("#goPAL").onclick = ()=> show("pal");
  root.querySelector("#goRead").onclick = ()=> show("read");
  root.querySelector("#goAdd").onclick = ()=> show("add");

  root.querySelector("#btnExport").onclick = exportBackup;
  root.querySelector("#btnLogout").onclick = ()=>{ logout(); show("login"); };
  root.querySelector("#btnImport").onchange = async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    try{ await importBackup(f); }
    catch(err){ alert(err.message || "Import impossible"); }
  };
}

/* ========= Lists ========= */
function renderList(kind){
  const root = document.getElementById("view-"+kind);
  const isEbook = kind === "ebooks";
  const subtitle = isEbook ? "Ebooks" : "Wishlist";
  const format = isEbook ? "ebook" : "wishlist";
  const obtainLabel = isEbook ? "T√©l√©charg√©" : "Achet√©";

  const books = (state.books || []).filter(b => b.format === format && !b.read && !b.acquired);

  root.innerHTML = `
    ${brandCenter(subtitle)}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('add')">Ôºã Ajouter</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
    </div>

    <div class="panel">
      <h2>
        <span>${subtitle}</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
        <div class="hint">Quand tu coches <b>${obtainLabel}</b>, le livre passe automatiquement dans <b>PAL</b>.</div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber, editionLabel(b.edition)].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">Aucun livre ici.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardObtainable(b, obtainLabel)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderCardObtainable(b, obtainLabel){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  const ed = editionLabel(b.edition);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}${ed ? " ‚Ä¢ " + escapeHtml(ed) : ""}</p>
        <div class="actions">
          <span class="chip" data-action="obtain" data-id="${escapeHtml(b.id)}">‚úì ${escapeHtml(obtainLabel)}</span>
          <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ========= PAL ========= */
function renderPAL(){
  const root = document.getElementById("view-pal");
  const books = (state.books || []).filter(b => b.acquired && !b.read);

  root.innerHTML = `
    ${brandCenter("PAL (√† lire)")}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${svgReader("small")} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${svgHeart("small")} Wishlist</button>
      <button class="btn" onclick="show('read')">${svgClosedBook("small")} Livres Lus</button>
    </div>

    <div class="panel">
      <h2>
        <span>PAL</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber, editionLabel(b.edition)].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">PAL vide.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardPAL(b)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderCardPAL(b){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  const ed = editionLabel(b.edition);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}${ed ? " ‚Ä¢ " + escapeHtml(ed) : ""}</p>
        <div class="actions">
          <span class="chip" data-action="read" data-id="${escapeHtml(b.id)}">‚úì Lu</span>
          <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ========= READ ========= */
function renderRead(){
  const root = document.getElementById("view-read");
  const books = (state.books || []).filter(b => b.read);

  root.innerHTML = `
    ${brandCenter("Livres Lus")}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
      <button class="btn danger" id="clear">Vider</button>
    </div>

    <div class="panel">
      <h2>
        <span>Livres Lus</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="readAt">Tri : lu r√©cemment</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    readAt:(a,b)=>(b.readAt||0)-(a.readAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber, editionLabel(b.edition)].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.readAt);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">Aucun livre lu pour l‚Äôinstant.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardRead(b)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);

  root.querySelector("#clear").onclick = ()=>{
    if(!confirm("Vider Livres Lus ?")) return;
    state.books = (state.books || []).filter(b => !b.read);
    saveState();
    show("read");
  };

  apply();
}

function renderCardRead(b){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  const fmt = formatFormatLabel(b);
  const ed = editionLabel(b.edition);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}${ed ? " ‚Ä¢ " + escapeHtml(ed) : ""}</p>
        <div class="actions">
          <span class="chip">${escapeHtml(fmt)}</span>
          <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ========= ADD ========= */
function renderAdd(){
  const root = document.getElementById("view-add");

  root.innerHTML = `
    ${brandCenter("Ajouter")}
    <div class="row" style="justify-content:center; margin-bottom:10px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${svgReader("small")} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${svgHeart("small")} Wishlist</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
    </div>

    <div class="panel">
      <h2><span>Recherche automatique (Google Books + Open Library)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="searchQuery" placeholder="Titre, auteur ou ISBN (ex: 978‚Ä¶)" />
          <button class="btn" id="searchBtn">Rechercher</button>
          <select id="formatPick">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
          </select>
          <select id="editionPick">
            <option value="auto">√âdition : Auto</option>
            <option value="poche">√âdition : Poche</option>
            <option value="broche">√âdition : Broch√©</option>
          </select>
        </div>
        <div class="hint">Astuce : tape un ISBN pour une couverture parfaitement fiable (poche/broch√©).</div>
      </div>
      <div class="content">
        <div id="searchStatus" class="hint"></div>
        <div id="searchResults" class="list"></div>
      </div>
    </div>

    <div class="panel">
      <h2><span>Ajout manuel</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="mTitle" placeholder="Titre" />
          <input class="input" id="mAuthor" placeholder="Auteur" />
        </div>
        <div class="row">
          <input class="input" id="mSeries" placeholder="S√©rie (optionnel)" />
          <input class="input" id="mVolume" placeholder="Tome n¬∞ (optionnel)" />
          <select id="mFormat">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
          </select>
          <select id="mEdition">
            <option value="auto">√âdition : Auto</option>
            <option value="poche">√âdition : Poche</option>
            <option value="broche">√âdition : Broch√©</option>
          </select>
        </div>
        <div class="row">
          <input class="input" id="mCover" placeholder="URL couverture (optionnel)" />
          <input class="input" id="mIsbn" placeholder="ISBN (optionnel)" />
        </div>
        <textarea class="input" id="mSummary" placeholder="R√©sum√© (optionnel)"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addManual">Ajouter</button>
          <button class="btn" id="resetManual">R√©initialiser</button>
        </div>
      </div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#searchQuery");
  const btn = root.querySelector("#searchBtn");
  const status = root.querySelector("#searchStatus");
  const results = root.querySelector("#searchResults");
  const formatPick = root.querySelector("#formatPick");
  const editionPick = root.querySelector("#editionPick");

  btn.addEventListener("click", ()=> doSearch());
  q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();

  async function doSearch(){
    const raw = (q.value||"").trim();
    if(!raw){
      status.textContent = "Tape un titre/auteur/ISBN puis lance la recherche.";
      results.innerHTML = "";
      return;
    }

    const baseQuery = normalizeQueryForBooks(raw);
    const edition = editionPick.value;
    const query = applyEditionToQuery(baseQuery, edition);

    status.textContent = "Recherche en cours‚Ä¶";
    results.innerHTML = "";

    // 1) Google Books FR
    try{
      const googleFR = await searchGoogleBooks(query, { lang: "fr" });
      if(googleFR.length){
        status.textContent = `R√©sultats (Google Books FR) : ${googleFR.length}`;
        results.innerHTML = googleFR.map(b => renderSearchCard(b, edition)).join("");
        bindSearchButtons(results, formatPick, editionPick);
        return;
      }
    }catch{}

    // 2) Google Books global
    try{
      const googleAll = await searchGoogleBooks(query, { lang: "" });
      if(googleAll.length){
        status.textContent = `R√©sultats (Google Books) : ${googleAll.length}`;
        results.innerHTML = googleAll.map(b => renderSearchCard(b, edition)).join("");
        bindSearchButtons(results, formatPick, editionPick);
        return;
      }
    }catch{}

    // 3) Open Library fallback
    try{
      const ol = await searchOpenLibrary(raw);
      if(ol.length){
        status.textContent = `R√©sultats (Open Library) : ${ol.length}`;
        results.innerHTML = ol.map(b => renderSearchCard(b, edition)).join("");
        bindSearchButtons(results, formatPick, editionPick);
        return;
      }
    }catch{}

    status.textContent = "Aucun r√©sultat. Essaie titre + auteur, ou un ISBN.";
  }

  function renderSearchCard(b, edition){
    const amazon = amazonSearchUrl({ title: b.title, authors: b.authors, edition });
    return `
      <div class="card">
        <div class="cover">
          ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : "Ôºã"}
        </div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(toAuthorsDisplay(b.authors))}${edition && edition !== "auto" ? " ‚Ä¢ " + escapeHtml(editionLabel(edition)) : ""}</p>
          <div class="actions">
            <span class="chip" data-action="add" data-id="${escapeHtml(b._previewId)}">‚ûï Ajouter</span>
            <a class="chip" href="${amazon}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
          </div>
        </div>
      </div>
    `;
  }

  function bindSearchButtons(container, formatPickEl, editionPickEl){
    container.querySelectorAll('[data-action="add"]').forEach(el=>{
      el.addEventListener("click", (e)=>{
        e.stopPropagation();
        const pid = el.dataset.id;
        const meta = window.__SEARCH_CACHE.get(pid);
        if(!meta) return;
        addBook(meta, formatPickEl.value, editionPickEl.value);
        saveState();
        status.textContent = "Ajout√© ‚úÖ";
      });
    });
  }

  root.querySelector("#addManual").addEventListener("click", ()=>{
    const title = root.querySelector("#mTitle").value.trim();
    const author = root.querySelector("#mAuthor").value.trim();
    const series = root.querySelector("#mSeries").value.trim();
    const volumeNumber = root.querySelector("#mVolume").value.trim();
    const coverUrl = root.querySelector("#mCover").value.trim();
    const isbn = root.querySelector("#mIsbn").value.trim();
    const summary = root.querySelector("#mSummary").value.trim();
    const format = root.querySelector("#mFormat").value;
    const edition = root.querySelector("#mEdition").value;

    if(!title){ alert("Titre obligatoire."); return; }

    addBook({ title, authors: author ? [author] : [], series, volumeNumber, coverUrl, isbn, summary }, format, edition);
    saveState();
    root.querySelector("#resetManual").click();
    alert("Ajout√© ‚úÖ");
  });

  root.querySelector("#resetManual").addEventListener("click", ()=>{
    ["mTitle","mAuthor","mSeries","mVolume","mCover","mIsbn","mSummary"].forEach(id=>{
      root.querySelector("#"+id).value = "";
    });
    root.querySelector("#mFormat").value = "ebook";
    root.querySelector("#mEdition").value = "auto";
  });
}

/* ========= Actions ========= */
function bindCards(container){
  container.querySelectorAll('[data-action="obtain"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = (state.books || []).find(b => b.id === id);
      if(!book) return;
      book.acquired = true;
      saveState();
      show("pal");
    });
  });

  container.querySelectorAll('[data-action="read"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = (state.books || []).find(b => b.id === id);
      if(!book) return;
      book.read = true;
      book.readAt = Date.now();
      saveState();
      show("read");
    });
  });

  container.querySelectorAll('[data-action="delete"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      if(!confirm("Supprimer ce livre ?")) return;
      state.books = (state.books || []).filter(b => b.id !== id);
      saveState();
      show(currentRoute);
    });
  });

  container.querySelectorAll("[data-open]").forEach(card=>{
    card.addEventListener("click", ()=> openModal(card.dataset.open));
  });
}

/* ========= Book add ========= */
function addBook(meta, format, edition="auto"){
  const book = {
    id: uid(),
    title: meta.title || "Sans titre",
    authors: meta.authors || [],
    series: meta.series || "",
    volumeNumber: meta.volumeNumber || "",
    format: format || "ebook",
    edition: edition || "auto",
    summary: meta.summary || "",
    coverUrl: meta.coverUrl || "",
    isbn: meta.isbn || "",
    acquired: false,
    read: false,
    createdAt: Date.now(),
    readAt: null
  };

  state.books = state.books || [];
  const key = (book.title + "|" + (book.authors?.[0]||"") + "|" + book.format + "|" + (book.edition||"") + "|" + (book.series||"") + "|" + (book.volumeNumber||"")).toLowerCase();
  const exists = state.books.some(b=>{
    const k = (b.title + "|" + (b.authors?.[0]||"") + "|" + b.format + "|" + (b.edition||"") + "|" + (b.series||"") + "|" + (b.volumeNumber||"")).toLowerCase();
    return k === key;
  });
  if(exists) return;

  state.books.unshift(book);
}

/* ========= Modal ========= */
function openModal(id){
  const book = (state.books || []).find(b => b.id === id);
  if(!book) return;

  const backdrop = document.getElementById("modalBackdrop");
  const cover = document.getElementById("modalCover");
  const desc = document.getElementById("modalDesc");
  const badges = document.getElementById("modalBadges");

  document.getElementById("modalTitle").textContent = book.title || "Sans titre";
  document.getElementById("modalAuthor").textContent = toAuthorsDisplay(book.authors);

  cover.innerHTML = book.coverUrl
    ? `<img src="${escapeHtml(book.coverUrl)}" alt="Couverture">`
    : `<div style="display:grid;place-items:center;height:100%;color:rgba(255,255,255,.35);font-weight:900;font-size:40px">${formatIconFallback(book)}</div>`;

  desc.textContent = (book.summary || "Aucune description trouv√©e.").trim();

  badges.innerHTML = `
    <span class="chip">${escapeHtml(formatFormatLabel(book))}</span>
    ${book.edition && book.edition !== "auto" ? `<span class="chip">${escapeHtml(editionLabel(book.edition))}</span>` : ""}
    ${book.series ? `<span class="chip">${escapeHtml(book.series)}${book.volumeNumber ? " ‚Äî Tome " + escapeHtml(book.volumeNumber) : ""}</span>` : ""}
    ${book.isbn ? `<span class="chip">ISBN: ${escapeHtml(book.isbn)}</span>` : ""}
    ${book.acquired ? `<span class="chip">PAL</span>` : `<span class="chip">√Ä obtenir</span>`}
    ${book.read ? `<span class="chip">Lu</span>` : ``}
  `;

  document.getElementById("modalAmazon").href = amazonSearchUrl(book);

  document.getElementById("modalDelete").onclick = ()=>{
    if(!confirm("Supprimer ce livre ?")) return;
    state.books = (state.books || []).filter(b => b.id !== id);
    saveState();
    closeModal();
    show(currentRoute);
  };

  backdrop.style.display = "flex";
}
function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
  if(e.target.id === "modalBackdrop") closeModal();
});

/* ========= Search helpers ========= */
function normalizeQueryForBooks(raw){
  const cleaned = String(raw).trim();
  const isbn = extractISBN(cleaned);
  if(isbn) return "isbn:" + isbn;
  return cleaned;
}
function extractISBN(text){
  const t = String(text).toUpperCase();
  const compact = t.replace(/[^0-9X]/g, "");
  if(compact.length === 10 || compact.length === 13){
    if(compact.length === 13 && compact.includes("X")) return null;
    return compact;
  }
  return null;
}

/* ========= APIs ========= */
async function searchGoogleBooks(query, opts = { lang: "fr" }){
  const url = new URL("https://www.googleapis.com/books/v1/volumes");
  url.searchParams.set("q", query);
  url.searchParams.set("maxResults", "20");
  url.searchParams.set("printType", "books");
  url.searchParams.set("orderBy", "relevance");
  if(opts?.lang) url.searchParams.set("langRestrict", opts.lang);

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("Google Books HTTP " + res.status);
  const data = await res.json();
  const items = data.items || [];
  const out = [];

  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();
  for(const it of items){
    const v = it.volumeInfo || {};
    const meta = {
      _previewId: uid(),
      title: v.title || "",
      authors: v.authors || [],
      summary: stripHtml(v.description || ""),
      isbn: pickIsbn(v.industryIdentifiers || []),
      coverUrl: normalizeCover(pickGoogleCover(v.imageLinks)),
      series: "",
      volumeNumber: ""
    };
    window.__SEARCH_CACHE.set(meta._previewId, meta);
    out.push(meta);
  }
  return out;
}
function pickGoogleCover(imageLinks){
  if(!imageLinks) return "";
  return imageLinks.thumbnail || imageLinks.smallThumbnail || imageLinks.small || imageLinks.medium || imageLinks.large || "";
}
function normalizeCover(url){
  if(!url) return "";
  let u = String(url).replace("http://", "https://");
  u = u.replace(/zoom=\d/g, "zoom=2");
  return u;
}
function pickIsbn(ids){
  const byType = {};
  for(const id of ids){
    if(id?.type && id?.identifier) byType[id.type] = id.identifier;
  }
  return byType.ISBN_13 || byType.ISBN_10 || "";
}
function stripHtml(html){ return String(html||"").replace(/<[^>]*>/g, "").trim(); }

async function searchOpenLibrary(query){
  const url = new URL("https://openlibrary.org/search.json");
  url.searchParams.set("q", query);
  url.searchParams.set("limit", "20");

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("OpenLibrary HTTP " + res.status);
  const data = await res.json();
  const docs = data.docs || [];
  const out = [];

  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();
  for(const d of docs){
    const meta = {
      _previewId: uid(),
      title: d.title || "",
      authors: d.author_name ? d.author_name.slice(0,3) : [],
      summary: "",
      isbn: d.isbn ? d.isbn[0] : "",
      coverUrl: d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-M.jpg` : "",
      series: "",
      volumeNumber: ""
    };
    window.__SEARCH_CACHE.set(meta._previewId, meta);
    out.push(meta);
  }
  return out;
}

/* ========= PWA SW ========= */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js?v=9").catch(()=>{});
  });
}

/* INIT */
if(currentUser){
  // Load user state
  state = loadUserState(currentUser.username);
  state.__meta = state.__meta || {};
  state.__meta.pinHash = currentUser.pinHash;
  saveState();
  show("home");
}else{
  show("login");
}
</script>
</body>
</html>
