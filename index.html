<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#F2B8C6" />
  <title>Books By Siana</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#50514D;
      --pink:#F2B8C6;
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --panel: rgba(0,0,0,.16);
      --border: rgba(255,255,255,.16);
      --shadow: 0 14px 34px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --w: 1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:var(--w); margin:0 auto; padding:18px}
    .view{display:none}
    .view.active{display:block}

    /* Centered brand */
    .brand-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 8px 0 18px;
      text-align:center;
    }
    .brand-center img{
      width:70px; height:70px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
    }
    .brand-center .name{
      font-weight:1000;
      font-size:20px;
      color: var(--pink);
      letter-spacing:.2px;
    }
    .brand-center .sub{
      font-size:12px;
      color: var(--muted);
      margin-top:-4px;
    }

    /* Buttons = Pink */
    .btn{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background: var(--pink);
      color:#2a2a2a;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:9px 11px; font-size:13px}
    .btn.danger{
      background: rgba(239,68,68,.92);
      color:#fff;
    }

    .panel{
      margin-top:12px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      padding:14px 16px;
      font-size:13px;
      color: var(--muted);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .content{padding:14px 16px}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    .input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:100px; resize: vertical}
    .hint{color: var(--muted); font-size:12px; margin-top:8px; line-height:1.35}

    /* Home */
    .home{
      margin-top:8px;
      min-height: calc(100vh - 200px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 26px;
    }
    .home-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap:18px;
      width:100%;
      max-width:520px;
    }
    .home-btn{
      position:relative;
      padding:26px 18px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .08s ease, background .2s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .home-btn:hover{transform: translateY(-2px); background: rgba(0,0,0,.24)}
    .home-btn b{font-size:14px; letter-spacing:.3px; color: var(--pink); margin-top:4px}
    .badge{
      position:absolute;
      top:10px; right:10px;
      min-width:34px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      font-weight:900;
      font-size:12px;
      color:#fff;
      text-align:center;
    }

    /* SVG icons */
    .ico{
      width:42px;
      height:42px;
      display:block;
    }
    .ico.small{
      width:18px;
      height:18px;
    }
    .ico path, .ico circle, .ico rect, .ico line, .ico polyline{
      stroke: var(--pink);
    }

    /* Lists */
    .list{
      display:grid;
      grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      padding:12px;
      display:flex;
      gap:12px;
      cursor:pointer;
      transition: transform .06s ease;
    }
    .card:hover{transform: translateY(-1px)}

    .cover{
      width:52px;
      height:78px;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:900;
      color: rgba(255,255,255,.7);
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}

    .meta{min-width:0; flex:1}
    .meta .t{margin:0 0 4px 0; font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta .a{margin:0 0 8px 0; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(242,184,198,.65);
      background: var(--pink);
      color:#2a2a2a;
      font-size:12px;
      font-weight:1000;
      user-select:none;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .chip.danger{
      background: rgba(239,68,68,.92);
      border-color: rgba(239,68,68,.55);
      color:#fff;
    }
    .empty{padding: 22px 16px; color: var(--muted); text-align:center; font-size:13px}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(30,30,30,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .modal .mhead b{color: var(--pink)}
    .modal .body{
      padding: 14px 16px 18px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 14px;
    }
    .bigcover{
      width:160px; height:230px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bigcover img{width:100%; height:100%; object-fit:cover; display:block}
    .desc{color:#fff; line-height:1.45; font-size:14px; white-space: pre-wrap}
    .mfoot{
      border-top:1px solid var(--border);
      padding:12px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    @media (max-width:720px){
      .home-grid{grid-template-columns: 1fr; max-width: 420px;}
      .modal .body{grid-template-columns: 1fr;}
      .bigcover{width:100%; height:320px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="view-home" class="view active"></div>
    <div id="view-ebooks" class="view"></div>
    <div id="view-wishlist" class="view"></div>
    <div id="view-pal" class="view"></div>
    <div id="view-read" class="view"></div>
    <div id="view-add" class="view"></div>
  </div>

  <!-- Modal d√©tails -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mhead">
        <div>
          <b id="modalTitle">‚Äî</b>
          <div id="modalAuthor" style="color:rgba(255,255,255,.78);font-size:12px;margin-top:2px">‚Äî</div>
        </div>
        <button class="btn small" id="modalClose">Fermer</button>
      </div>

      <div class="body">
        <div class="bigcover" id="modalCover"></div>
        <div>
          <div class="desc" id="modalDesc"></div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap" id="modalBadges"></div>
        </div>
      </div>

      <div class="mfoot">
        <button class="btn danger" id="modalDelete">Supprimer</button>
      </div>
    </div>
  </div>

<script>
/* Books By Siana - v6 (SVG icons in buttons) */

const STORAGE_KEY = "bbs.books.v6";
const state = loadState();
let currentRoute = "home";
let currentModalBookId = null;

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { books: [] };
    const parsed = JSON.parse(raw);
    if(!parsed.books) return { books: [] };
    return parsed;
  }catch{
    return { books: [] };
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function toAuthorsDisplay(authors){
  if(!authors || !authors.length) return "Auteur inconnu";
  return authors.join(", ");
}
function formatFormatLabel(book){ return book.format === "ebook" ? "Ebook" : "Wishlist"; }
function formatIconFallback(book){ return book.format === "ebook" ? "üì±" : "‚ù§"; }

/* ===== SVG ICONS (stroke = pink via CSS) ===== */
function svgReader(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="7" y="2.8" width="10" height="18.4" rx="2.2"></rect>
      <line x1="9" y1="6" x2="15" y2="6"></line>
      <circle cx="12" cy="18" r="0.9" fill="none"></circle>
    </svg>
  `;
}
function svgHeart(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M20.4 4.9c-1.6-1.7-4.2-1.7-5.8 0L12 7.5 9.4 4.9c-1.6-1.7-4.2-1.7-5.8 0-1.8 1.9-1.7 4.9.2 6.7L12 20l8.2-8.4c1.9-1.8 2-4.8.2-6.7z"></path>
    </svg>
  `;
}
function svgOpenBook(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 19c-2.2-1.5-5.2-2.2-8-2V6c2.8-.2 5.8.6 8 2"></path>
      <path d="M12 19c2.2-1.5 5.2-2.2 8-2V6c-2.8-.2-5.8.6-8 2"></path>
      <line x1="12" y1="8" x2="12" y2="19"></line>
    </svg>
  `;
}
function svgClosedBook(cls=""){
  return `
    <svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M7 3h10a2 2 0 0 1 2 2v15a1.5 1.5 0 0 1-1.5 1.5H8.5A1.5 1.5 0 0 1 7 20V3z"></path>
      <line x1="9" y1="7" x2="15" y2="7"></line>
      <line x1="9" y1="11" x2="15" y2="11"></line>
      <line x1="7" y1="20" x2="19" y2="20"></line>
    </svg>
  `;
}

/* ===== routing ===== */
function show(route){
  currentRoute = route;
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("view-"+route).classList.add("active");

  if(route === "home") renderHome();
  if(route === "ebooks") renderList("ebooks");
  if(route === "wishlist") renderList("wishlist");
  if(route === "pal") renderPAL();
  if(route === "read") renderRead();
  if(route === "add") renderAdd();
}
function backToHome(){ show("home"); }

/* ===== centered brand block ===== */
function brandCenter(subtitle){
  return `
    <div class="brand-center">
      <img src="./bbs-logo.png" alt="BBS">
      <div class="name">Books By Siana</div>
      <div class="sub">${escapeHtml(subtitle)}</div>
    </div>
  `;
}

/* ===== stats ===== */
function getStats(){
  const ebooks = state.books.filter(b => b.format === "ebook" && !b.read && !b.acquired).length;
  const wishlist = state.books.filter(b => b.format === "wishlist" && !b.read && !b.acquired).length;
  const pal = state.books.filter(b => !b.read && b.acquired).length;
  const read = state.books.filter(b => b.read).length;
  return { ebooks, wishlist, pal, read, total: state.books.length };
}

/* ===== HOME ===== */
function renderHome(){
  const root = document.getElementById("view-home");
  const s = getStats();

  root.innerHTML = `
    ${brandCenter("Accueil")}

    <div class="home">
      <div class="home-grid">
        <div class="home-btn" id="goEbooks">
          <div class="badge">${s.ebooks}</div>
          ${svgReader("")}
          <b>Ebooks</b>
        </div>

        <div class="home-btn" id="goWishlist">
          <div class="badge">${s.wishlist}</div>
          ${svgHeart("")}
          <b>Wishlist</b>
        </div>

        <div class="home-btn" id="goPAL">
          <div class="badge">${s.pal}</div>
          ${svgOpenBook("")}
          <b>PAL</b>
        </div>

        <div class="home-btn" id="goRead">
          <div class="badge">${s.read}</div>
          ${svgClosedBook("")}
          <b>Livres Lus</b>
        </div>

        <div class="home-btn" id="goAdd" style="grid-column: 1 / -1;">
          <div class="badge">+</div>
          <div style="font-size:34px; font-weight:1000; color: var(--pink); line-height:1">+</div>
          <b>Ajouter un livre</b>
        </div>
      </div>
    </div>
  `;

  root.querySelector("#goEbooks").onclick = ()=> show("ebooks");
  root.querySelector("#goWishlist").onclick = ()=> show("wishlist");
  root.querySelector("#goPAL").onclick = ()=> show("pal");
  root.querySelector("#goRead").onclick = ()=> show("read");
  root.querySelector("#goAdd").onclick = ()=> show("add");
}

/* ===== Lists: Ebooks & Wishlist ===== */
function renderList(kind){
  const root = document.getElementById("view-"+kind);
  const isEbook = kind === "ebooks";
  const subtitle = isEbook ? "Ebooks" : "Wishlist";
  const format = isEbook ? "ebook" : "wishlist";
  const obtainLabel = isEbook ? "T√©l√©charg√©" : "Achet√©";

  const books = state.books.filter(b => b.format === format && !b.read && !b.acquired);

  const iconE = svgReader("small");
  const iconW = svgHeart("small");
  const iconP = svgOpenBook("small");
  const iconR = svgClosedBook("small");

  root.innerHTML = `
    ${brandCenter(subtitle)}

    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('add')">Ôºã Ajouter</button>
      <button class="btn" onclick="show('pal')">${iconP} PAL</button>
    </div>

    <div class="panel">
      <h2>
        <span>${subtitle}</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
        <div class="hint">Quand tu coches <b>${obtainLabel}</b>, le livre passe automatiquement dans <b>PAL</b>.</div>
      </div>
      <div class="divider"></div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">Aucun livre ici.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardObtainable(b, obtainLabel)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderCardObtainable(b, obtainLabel){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}</p>
        <div class="actions">
          <span class="chip" data-action="obtain" data-id="${escapeHtml(b.id)}">‚úì ${escapeHtml(obtainLabel)}</span>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ===== PAL ===== */
function renderPAL(){
  const root = document.getElementById("view-pal");
  const books = state.books.filter(b => b.acquired && !b.read);

  const iconE = svgReader("small");
  const iconW = svgHeart("small");
  const iconR = svgClosedBook("small");

  root.innerHTML = `
    ${brandCenter("PAL (√† lire)")}

    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${iconE} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${iconW} Wishlist</button>
      <button class="btn" onclick="show('read')">${iconR} Livres Lus</button>
    </div>

    <div class="panel">
      <h2>
        <span>PAL</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
        <div class="hint">Ici tu marques les livres comme <b>Lu</b> ‚Üí ils partent dans <b>Livres Lus</b>.</div>
      </div>
      <div class="divider"></div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">PAL vide. Mets un livre en ‚ÄúT√©l√©charg√©/Achet√©‚Äù depuis Ebooks/Wishlist.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardPAL(b)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderCardPAL(b){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}</p>
        <div class="actions">
          <span class="chip" data-action="read" data-id="${escapeHtml(b.id)}">‚úì Lu</span>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ===== READ ===== */
function renderRead(){
  const root = document.getElementById("view-read");
  const books = state.books.filter(b => b.read);

  const iconP = svgOpenBook("small");

  root.innerHTML = `
    ${brandCenter("Livres Lus")}

    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('pal')">${iconP} PAL</button>
      <button class="btn danger" id="clear">Vider</button>
    </div>

    <div class="panel">
      <h2>
        <span>Livres Lus</span>
        <span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span>
      </h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="readAt">Tri : lu r√©cemment</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    readAt:(a,b)=>(b.readAt||0)-(a.readAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => {
        const hay = [b.title, (b.authors||[]).join(" "), b.series, b.volumeNumber].join(" ").toLowerCase();
        return hay.includes(query);
      });
    }
    filtered.sort(sorter[sortSel.value] || sorter.readAt);

    if(!filtered.length){
      cards.innerHTML = `<div class="empty">Aucun livre lu pour l‚Äôinstant.</div>`;
      return;
    }

    cards.innerHTML = filtered.map(b => renderCardRead(b)).join("");
    bindCards(cards);
  }

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);

  root.querySelector("#clear").onclick = ()=>{
    if(!confirm("Vider Livres Lus ?")) return;
    state.books = state.books.filter(b => !b.read);
    saveState();
    show("read");
  };

  apply();
}

function renderCardRead(b){
  const icon = (b.format === "ebook") ? "üì±" : "‚ù§";
  const author = toAuthorsDisplay(b.authors);
  const fmt = formatFormatLabel(b);
  return `
    <div class="card" data-open="${escapeHtml(b.id)}">
      <div class="cover">
        ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : icon}
      </div>
      <div class="meta">
        <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
        <p class="a">${escapeHtml(author)}</p>
        <div class="actions">
          <span class="chip">${escapeHtml(fmt)}</span>
          <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
        </div>
      </div>
    </div>
  `;
}

/* ===== ADD ===== */
function renderAdd(){
  const root = document.getElementById("view-add");

  const iconE = svgReader("small");
  const iconW = svgHeart("small");
  const iconP = svgOpenBook("small");

  root.innerHTML = `
    ${brandCenter("Ajouter")}

    <div class="row" style="justify-content:center; margin-bottom:10px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${iconE} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${iconW} Wishlist</button>
      <button class="btn" onclick="show('pal')">${iconP} PAL</button>
    </div>

    <div class="panel">
      <h2><span>Recherche automatique (couverture + r√©sum√©)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="searchQuery" placeholder="Titre, auteur ou ISBN (ex: 'Dune Herbert')" />
          <button class="btn" id="searchBtn">Rechercher</button>
          <select id="formatPick">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
          </select>
        </div>
        <div class="hint">Les livres ajout√©s arrivent dans Ebooks ou Wishlist (avant obtention).</div>
      </div>
      <div class="content">
        <div id="searchStatus" class="hint"></div>
        <div id="searchResults" class="list"></div>
      </div>
    </div>

    <div class="panel">
      <h2><span>Ajout manuel</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="mTitle" placeholder="Titre" />
          <input class="input" id="mAuthor" placeholder="Auteur" />
        </div>
        <div class="row">
          <input class="input" id="mSeries" placeholder="S√©rie (optionnel)" />
          <input class="input" id="mVolume" placeholder="Tome n¬∞ (optionnel)" />
          <select id="mFormat">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
          </select>
        </div>
        <div class="row">
          <input class="input" id="mCover" placeholder="URL couverture (optionnel)" />
          <input class="input" id="mIsbn" placeholder="ISBN (optionnel)" />
        </div>
        <textarea class="input" id="mSummary" placeholder="R√©sum√© (optionnel)"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addManual">Ajouter</button>
          <button class="btn" id="resetManual">R√©initialiser</button>
        </div>
      </div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#searchQuery");
  const btn = root.querySelector("#searchBtn");
  const status = root.querySelector("#searchStatus");
  const results = root.querySelector("#searchResults");
  const formatPick = root.querySelector("#formatPick");

  btn.addEventListener("click", ()=> doSearch());
  q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();

  async function doSearch(){
    const query = (q.value||"").trim();
    if(!query){
      status.textContent = "Tape un titre/auteur/ISBN puis lance la recherche.";
      results.innerHTML = "";
      return;
    }
    status.textContent = "Recherche en cours‚Ä¶";
    results.innerHTML = "";

    try{
      const google = await searchGoogleBooks(query);
      if(google.length){
        status.textContent = `R√©sultats (Google Books): ${google.length}`;
        results.innerHTML = google.map(b => renderSearchCard(b)).join("");
        bindSearchButtons(results);
        return;
      }
    }catch{}

    try{
      const ol = await searchOpenLibrary(query);
      if(ol.length){
        status.textContent = `R√©sultats (Open Library): ${ol.length}`;
        results.innerHTML = ol.map(b => renderSearchCard(b)).join("");
        bindSearchButtons(results);
        return;
      }
    }catch{}

    status.textContent = "Aucun r√©sultat. Essaie un autre mot-cl√© ou utilise l‚Äôajout manuel.";
  }

  function renderSearchCard(b){
    return `
      <div class="card">
        <div class="cover">
          ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : "Ôºã"}
        </div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(toAuthorsDisplay(b.authors))}</p>
          <div class="actions">
            <span class="chip" data-action="add" data-id="${escapeHtml(b._previewId)}">‚ûï Ajouter</span>
          </div>
        </div>
      </div>
    `;
  }

  function bindSearchButtons(container){
    container.querySelectorAll('[data-action="add"]').forEach(el=>{
      el.addEventListener("click", (e)=>{
        e.stopPropagation();
        const pid = el.dataset.id;
        const meta = window.__SEARCH_CACHE.get(pid);
        if(!meta) return;
        addBook(meta, formatPick.value);
        saveState();
        status.textContent = "Ajout√© ‚úÖ";
      });
    });
  }

  root.querySelector("#addManual").addEventListener("click", ()=>{
    const title = root.querySelector("#mTitle").value.trim();
    const author = root.querySelector("#mAuthor").value.trim();
    const series = root.querySelector("#mSeries").value.trim();
    const volumeNumber = root.querySelector("#mVolume").value.trim();
    const coverUrl = root.querySelector("#mCover").value.trim();
    const isbn = root.querySelector("#mIsbn").value.trim();
    const summary = root.querySelector("#mSummary").value.trim();
    const format = root.querySelector("#mFormat").value;

    if(!title){ alert("Titre obligatoire."); return; }

    addBook({ title, authors: author ? [author] : [], series, volumeNumber, coverUrl, isbn, summary }, format);
    saveState();
    root.querySelector("#resetManual").click();
    alert("Ajout√© ‚úÖ");
  });

  root.querySelector("#resetManual").addEventListener("click", ()=>{
    ["mTitle","mAuthor","mSeries","mVolume","mCover","mIsbn","mSummary"].forEach(id=>{
      root.querySelector("#"+id).value = "";
    });
    root.querySelector("#mFormat").value = "ebook";
  });
}

/* ===== actions ===== */
function bindCards(container){
  container.querySelectorAll('[data-action="obtain"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = state.books.find(b => b.id === id);
      if(!book) return;
      book.acquired = true;
      saveState();
      show("pal");
    });
  });

  container.querySelectorAll('[data-action="read"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = state.books.find(b => b.id === id);
      if(!book) return;
      book.read = true;
      book.readAt = Date.now();
      saveState();
      show("read");
    });
  });

  container.querySelectorAll('[data-action="delete"]').forEach(el=>{
    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      if(!confirm("Supprimer ce livre ?")) return;
      state.books = state.books.filter(b => b.id !== id);
      saveState();
      show(currentRoute);
    });
  });

  container.querySelectorAll("[data-open]").forEach(card=>{
    card.addEventListener("click", ()=> openModal(card.dataset.open));
  });
}

/* ===== book add ===== */
function addBook(meta, format){
  const book = {
    id: uid(),
    title: meta.title || "Sans titre",
    authors: meta.authors || [],
    series: meta.series || "",
    volumeNumber: meta.volumeNumber || "",
    format: format || "ebook",
    summary: meta.summary || "",
    coverUrl: meta.coverUrl || "",
    isbn: meta.isbn || "",
    acquired: false,
    read: false,
    createdAt: Date.now(),
    readAt: null
  };

  const key = (book.title + "|" + (book.authors?.[0]||"") + "|" + book.format + "|" + (book.series||"") + "|" + (book.volumeNumber||"")).toLowerCase();
  const exists = state.books.some(b=>{
    const k = (b.title + "|" + (b.authors?.[0]||"") + "|" + b.format + "|" + (b.series||"") + "|" + (b.volumeNumber||"")).toLowerCase();
    return k === key;
  });
  if(exists) return;

  state.books.unshift(book);
}

/* ===== Modal ===== */
function openModal(id){
  const book = state.books.find(b => b.id === id);
  if(!book) return;
  currentModalBookId = id;

  const backdrop = document.getElementById("modalBackdrop");
  const cover = document.getElementById("modalCover");
  const desc = document.getElementById("modalDesc");
  const badges = document.getElementById("modalBadges");

  document.getElementById("modalTitle").textContent = book.title || "Sans titre";
  document.getElementById("modalAuthor").textContent = toAuthorsDisplay(book.authors);

  cover.innerHTML = book.coverUrl
    ? `<img src="${escapeHtml(book.coverUrl)}" alt="Couverture">`
    : `<div style="display:grid;place-items:center;height:100%;color:rgba(255,255,255,.35);font-weight:900;font-size:40px">${formatIconFallback(book)}</div>`;

  desc.textContent = (book.summary || "Aucune description trouv√©e.").trim();

  badges.innerHTML = `
    <span class="chip">${escapeHtml(formatFormatLabel(book))}</span>
    ${book.series ? `<span class="chip">${escapeHtml(book.series)}${book.volumeNumber ? " ‚Äî Tome " + escapeHtml(book.volumeNumber) : ""}</span>` : ""}
    ${book.isbn ? `<span class="chip">ISBN: ${escapeHtml(book.isbn)}</span>` : ""}
    ${book.acquired ? `<span class="chip">PAL</span>` : `<span class="chip">√Ä obtenir</span>`}
    ${book.read ? `<span class="chip">Lu</span>` : ``}
  `;

  document.getElementById("modalDelete").onclick = ()=>{
    if(!confirm("Supprimer ce livre ?")) return;
    state.books = state.books.filter(b => b.id !== id);
    saveState();
    closeModal();
    show(currentRoute);
  };

  backdrop.style.display = "flex";
}
function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }

document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
  if(e.target.id === "modalBackdrop") closeModal();
});

/* ===== APIs ===== */
async function searchGoogleBooks(query){
  const url = new URL("https://www.googleapis.com/books/v1/volumes");
  url.searchParams.set("q", query);
  url.searchParams.set("maxResults", "12");

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("Google Books HTTP " + res.status);
  const data = await res.json();
  const items = data.items || [];
  const out = [];

  for(const it of items){
    const v = it.volumeInfo || {};
    const meta = {
      _previewId: uid(),
      title: v.title || "",
      authors: v.authors || [],
      summary: stripHtml(v.description || ""),
      isbn: pickIsbn(v.industryIdentifiers || []),
      coverUrl: pickGoogleCover(v.imageLinks),
      series: "",
      volumeNumber: ""
    };
    window.__SEARCH_CACHE.set(meta._previewId, meta);
    out.push(meta);
  }
  return out;
}
function pickGoogleCover(imageLinks){
  if(!imageLinks) return "";
  return imageLinks.thumbnail || imageLinks.smallThumbnail || imageLinks.small || imageLinks.medium || "";
}
function pickIsbn(ids){
  const byType = {};
  for(const id of ids){
    if(id?.type && id?.identifier) byType[id.type] = id.identifier;
  }
  return byType.ISBN_13 || byType.ISBN_10 || "";
}
function stripHtml(html){ return String(html||"").replace(/<[^>]*>/g, "").trim(); }

async function searchOpenLibrary(query){
  const url = new URL("https://openlibrary.org/search.json");
  url.searchParams.set("q", query);
  url.searchParams.set("limit", "12");

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("OpenLibrary HTTP " + res.status);
  const data = await res.json();
  const docs = data.docs || [];
  const out = [];

  for(const d of docs){
    const meta = {
      _previewId: uid(),
      title: d.title || "",
      authors: d.author_name ? d.author_name.slice(0,3) : [],
      summary: "",
      isbn: d.isbn ? d.isbn[0] : "",
      coverUrl: d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-M.jpg` : "",
      series: "",
      volumeNumber: ""
    };
    window.__SEARCH_CACHE.set(meta._previewId, meta);
    out.push(meta);
  }
  return out;
}

/* ===== PWA SW ===== */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/* INIT */
show("home");
</script>
</body>
</html>
