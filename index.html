<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#F2B8C6" />
  <title>Books By Siana</title>

  <style>
    :root{
      --bg:#50514D;
      --pink:#F2B8C6;
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --panel: rgba(0,0,0,.16);
      --border: rgba(255,255,255,.16);
      --shadow: 0 14px 34px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --w: 1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:var(--w); margin:0 auto; padding:18px}
    .view{display:none}
    .view.active{display:block}

    .brand-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 8px 0 18px;
      text-align:center;
    }
    .brand-center img{
      width:70px; height:70px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
    }
    .brand-center .name{
      font-weight:1000;
      font-size:20px;
      color: var(--pink);
      letter-spacing:.2px;
    }
    .brand-center .sub{
      font-size:12px;
      color: var(--muted);
      margin-top:-4px;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background: var(--pink);
      color:#2a2a2a;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:9px 11px; font-size:13px}
    .btn.danger{ background: rgba(239,68,68,.92); color:#fff; }

    .panel{
      margin-top:12px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      padding:14px 16px;
      font-size:13px;
      color: var(--muted);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .content{padding:14px 16px}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    .input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:100px; resize: vertical}
    .hint{color: var(--muted); font-size:12px; margin-top:8px; line-height:1.35}

    .home{
      margin-top:8px;
      min-height: calc(100vh - 200px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 26px;
    }
    .home-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap:18px;
      width:100%;
      max-width:520px;
    }
    .home-btn{
      position:relative;
      padding:26px 18px;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .08s ease, background .2s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .home-btn:hover{transform: translateY(-2px); background: rgba(0,0,0,.24)}
    .home-btn b{font-size:14px; letter-spacing:.3px; color: var(--pink); margin-top:4px}
    .badge{
      position:absolute;
      top:10px; right:10px;
      min-width:34px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      font-weight:900;
      font-size:12px;
      color:#fff;
      text-align:center;
    }

    .ico{width:42px;height:42px;display:block}
    .ico.small{width:18px;height:18px}
    .ico path, .ico circle, .ico rect, .ico line, .ico polyline{stroke: var(--pink)}

    .list{
      display:grid;
      grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      padding:12px;
      display:flex;
      gap:12px;
      cursor:pointer;
      transition: transform .06s ease;
    }
    .card:hover{transform: translateY(-1px)}

    .cover{
      width:52px;
      height:78px;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:900;
      color: rgba(255,255,255,.7);
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}

    .meta{min-width:0; flex:1}
    .meta .t{margin:0 0 4px 0; font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta .a{margin:0 0 8px 0; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(242,184,198,.65);
      background: var(--pink);
      color:#2a2a2a;
      font-size:12px;
      font-weight:1000;
      user-select:none;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      text-decoration:none;
      white-space:nowrap;
    }
    .chip.danger{
      background: rgba(239,68,68,.92);
      border-color: rgba(239,68,68,.55);
      color:#fff;
    }
    .chip.disabled{
      opacity:.55;
      cursor:default;
      pointer-events:none;
    }
    .empty{padding: 22px 16px; color: var(--muted); text-align:center; font-size:13px}

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(30,30,30,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .modal .mhead b{color: var(--pink)}
    .modal .body{
      padding: 14px 16px 18px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 14px;
    }
    .bigcover{
      width:160px; height:230px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bigcover img{width:100%; height:100%; object-fit:cover; display:block}
    .desc{color:#fff; line-height:1.45; font-size:14px; white-space: pre-wrap}
    .mfoot{
      border-top:1px solid var(--border);
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    @media (max-width:720px){
      .home-grid{grid-template-columns: 1fr; max-width: 420px;}
      .modal .body{grid-template-columns: 1fr;}
      .bigcover{width:100%; height:320px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="view-login" class="view active"></div>
    <div id="view-home" class="view"></div>

    <div id="view-ebooks" class="view"></div>
    <div id="view-wishlist" class="view"></div>
    <div id="view-wattpad" class="view"></div>

    <div id="view-pal" class="view"></div>
    <div id="view-read" class="view"></div>
    <div id="view-add" class="view"></div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mhead">
        <div>
          <b id="modalTitle">‚Äî</b>
          <div id="modalAuthor" style="color:rgba(255,255,255,.78);font-size:12px;margin-top:2px">‚Äî</div>
        </div>
        <button class="btn small" id="modalClose">Fermer</button>
      </div>

      <div class="body">
        <div class="bigcover" id="modalCover"></div>
        <div>
          <div class="desc" id="modalDesc"></div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap" id="modalBadges"></div>
        </div>
      </div>

      <div class="mfoot">
        <label class="btn small" style="cursor:pointer">
          Couverture
          <input id="modalCoverFile" type="file" accept="image/*" style="display:none">
        </label>
        <button class="btn small" id="modalRemoveCover">Retirer</button>
        <a class="btn small" id="modalAmazon" target="_blank" rel="noopener">Amazon</a>
        <button class="btn danger small" id="modalDelete">Supprimer</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   Books By Siana - UI
   ========================= */
let currentRoute = "login";
let booksCache = [];
let authUser = null;

const LOCAL_FALLBACK_KEY = "bbs_local_cache_v1";

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function safeUsername(u){
  return String(u || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^a-z0-9_\-]/g, "")
    .slice(0, 24);
}
function isValidPin(pin){ return /^[0-9]{4}$/.test(String(pin || "")); }
function toAuthorsDisplay(authors){
  if(!authors || !authors.length) return "Auteur inconnu";
  return authors.join(", ");
}
function formatFormatLabel(book){
  if(book.format === "ebook") return "Ebook";
  if(book.format === "wishlist") return "Wishlist";
  if(book.format === "wattpad") return "Wattpad";
  return "‚Äî";
}
function formatIconFallback(book){
  if(book.format === "ebook") return "üì±";
  if(book.format === "wishlist") return "‚ù§";
  if(book.format === "wattpad") return "‚úçÔ∏è";
  return "üìò";
}
function amazonSearchUrl(book){
  const title = book?.title || "";
  const author = (book?.authors && book.authors.length) ? book.authors[0] : "";
  const q = `${title} ${author}`.trim();
  return "https://www.amazon.fr/s?k=" + encodeURIComponent(q);
}
function brandCenter(subtitle){
  const who = authUser?.displayName ? `‚Ä¢ ${escapeHtml(authUser.displayName)}` : "";
  return `
    <div class="brand-center">
      <img src="./bbs-logo.png" alt="BBS">
      <div class="name">Books By Siana</div>
      <div class="sub">${escapeHtml(subtitle)} ${who}</div>
    </div>
  `;
}

function show(route){
  currentRoute = route;
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("view-"+route).classList.add("active");

  if(route === "login") renderLogin();
  if(route === "home") renderHome();

  if(route === "ebooks") renderList("ebooks");
  if(route === "wishlist") renderList("wishlist");
  if(route === "wattpad") renderList("wattpad");

  if(route === "pal") renderPAL();
  if(route === "read") renderRead();
  if(route === "add") renderAdd();
}
window.show = show;

function backToHome(){ show("home"); }

/* ===== SVG ICONS ===== */
function svgReader(cls=""){ return `<svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="7" y="2.8" width="10" height="18.4" rx="2.2"></rect><line x1="9" y1="6" x2="15" y2="6"></line><circle cx="12" cy="18" r="0.9"></circle></svg>`; }
function svgHeart(cls=""){ return `<svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.4 4.9c-1.6-1.7-4.2-1.7-5.8 0L12 7.5 9.4 4.9c-1.6-1.7-4.2-1.7-5.8 0-1.8 1.9-1.7 4.9.2 6.7L12 20l8.2-8.4c1.9-1.8 2-4.8.2-6.7z"></path></svg>`; }
function svgOpenBook(cls=""){ return `<svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19c-2.2-1.5-5.2-2.2-8-2V6c2.8-.2 5.8.6 8 2"></path><path d="M12 19c2.2-1.5 5.2-2.2 8-2V6c-2.8-.2-5.8.6-8 2"></path><line x1="12" y1="8" x2="12" y2="19"></line></svg>`; }
function svgClosedBook(cls=""){ return `<svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h10a2 2 0 0 1 2 2v15a1.5 1.5 0 0 1-1.5 1.5H8.5A1.5 1.5 0 0 1 7 20V3z"></path><line x1="9" y1="7" x2="15" y2="7"></line><line x1="9" y1="11" x2="15" y2="11"></line><line x1="7" y1="20" x2="19" y2="20"></line></svg>`; }
function svgPen(cls=""){ return `<svg class="ico ${cls}" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z"></path></svg>`; }

/* ===== Data helpers ===== */
function getStats(){
  const books = booksCache || [];
  return {
    ebooks: books.filter(b => b.format === "ebook" && !b.read && !b.acquired).length,
    wishlist: books.filter(b => b.format === "wishlist" && !b.read && !b.acquired).length,
    wattpad: books.filter(b => b.format === "wattpad" && !b.read && !b.acquired).length,
    pal: books.filter(b => !b.read && b.acquired).length,
    read: books.filter(b => b.read).length
  };
}

function loadLocalCache(){
  try{
    const raw = localStorage.getItem(LOCAL_FALLBACK_KEY);
    if(!raw) return [];
    const p = JSON.parse(raw);
    return Array.isArray(p?.books) ? p.books : [];
  }catch{ return []; }
}

/* =========================
   UI RENDER
   ========================= */
function renderLogin(){
  const root = document.getElementById("view-login");
  root.innerHTML = `
    ${brandCenter("Connexion")}
    <div class="panel">
      <h2><span>Connexion (pseudo + PIN 4 chiffres)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="lgUser" placeholder="Pseudo (ex: siana)" autocomplete="username" />
          <input class="input" id="lgPin" placeholder="PIN (4 chiffres)" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="current-password" />
        </div>
        <div class="row" style="margin-top:10px; justify-content:center">
          <button class="btn" id="lgBtn">Connexion</button>
        </div>
        <div class="hint" id="lgMsg"></div>
        <div class="hint">Astuce : la synchro se fait automatiquement via Firestore/Storage (cloud).</div>
      </div>
    </div>
  `;

  const uEl = root.querySelector("#lgUser");
  const pEl = root.querySelector("#lgPin");
  const msg = root.querySelector("#lgMsg");

  pEl.addEventListener("input", ()=>{ pEl.value = pEl.value.replace(/[^0-9]/g, "").slice(0,4); });

  root.querySelector("#lgBtn").onclick = async ()=>{
    msg.textContent = "";
    const username = safeUsername(uEl.value);
    const pin = pEl.value;

    if(!username){ msg.textContent = "Pseudo invalide."; return; }
    if(!isValidPin(pin)){ msg.textContent = "PIN invalide (4 chiffres)."; return; }

    try{
      await window.BBS_CLOUD.signInOrCreate(username, pin);
    }catch(e){
      msg.textContent = (e && e.message) ? e.message : "Erreur de connexion";
    }
  };
}

function renderHome(){
  const root = document.getElementById("view-home");
  const s = getStats();

  root.innerHTML = `
    ${brandCenter("Accueil")}
    <div class="home">
      <div style="width:100%">
        <div class="home-grid">
          <div class="home-btn" id="goEbooks"><div class="badge">${s.ebooks}</div>${svgReader("")}<b>Ebooks</b></div>
          <div class="home-btn" id="goWishlist"><div class="badge">${s.wishlist}</div>${svgHeart("")}<b>Wishlist</b></div>
          <div class="home-btn" id="goWattpad"><div class="badge">${s.wattpad}</div>${svgPen("")}<b>Wattpad</b></div>
          <div class="home-btn" id="goPAL"><div class="badge">${s.pal}</div>${svgOpenBook("")}<b>PAL</b></div>
          <div class="home-btn" id="goRead"><div class="badge">${s.read}</div>${svgClosedBook("")}<b>Livres Lus</b></div>
          <div class="home-btn" id="goAdd" style="grid-column: 1 / -1;"><div class="badge">+</div><div style="font-size:34px;font-weight:1000;color:var(--pink);line-height:1">+</div><b>Ajouter un livre</b></div>
        </div>

        <div class="row" style="justify-content:center; margin-top:12px">
          <button class="btn small" id="btnReload">Rafra√Æchir</button>
          <button class="btn small danger" id="btnLogout">D√©connexion</button>
        </div>
      </div>
    </div>
  `;

  root.querySelector("#goEbooks").onclick = ()=> show("ebooks");
  root.querySelector("#goWishlist").onclick = ()=> show("wishlist");
  root.querySelector("#goWattpad").onclick = ()=> show("wattpad");
  root.querySelector("#goPAL").onclick = ()=> show("pal");
  root.querySelector("#goRead").onclick = ()=> show("read");
  root.querySelector("#goAdd").onclick = ()=> show("add");

  root.querySelector("#btnReload").onclick = async ()=>{
    await window.BBS_CLOUD.reloadBooks();
    show("home");
  };
  root.querySelector("#btnLogout").onclick = async ()=>{ await window.BBS_CLOUD.signOut(); };
}

function rerenderCurrent(){ show(currentRoute); }
window.rerenderCurrent = rerenderCurrent;

function renderList(kind){
  const root = document.getElementById("view-"+kind);

  const map = {
    ebooks:   { subtitle:"Ebooks",   format:"ebook",   obtain:"T√©l√©charg√©" },
    wishlist: { subtitle:"Wishlist", format:"wishlist", obtain:"Achet√©" },
    wattpad:  { subtitle:"Wattpad",  format:"wattpad",  obtain:"Ajout√©" }
  };
  const conf = map[kind];

  const subtitle = conf.subtitle;
  const format = conf.format;
  const obtainLabel = conf.obtain;

  const books = (booksCache || []).filter(b => b.format === format && !b.read && !b.acquired);

  root.innerHTML = `
    ${brandCenter(subtitle)}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('add')">Ôºã Ajouter</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
    </div>
    <div class="panel">
      <h2><span>${subtitle}</span><span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
        <div class="hint">Quand tu coches <b>${escapeHtml(obtainLabel)}</b>, le livre passe automatiquement dans <b>PAL</b>.</div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;
  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function renderCard(b){
    const icon = formatIconFallback(b);
    const coverSrc = b.coverUrl || "";
    const author = toAuthorsDisplay(b.authors);
    return `
      <div class="card" data-open="${escapeHtml(b.id)}">
        <div class="cover">${coverSrc ? `<img src="${escapeHtml(coverSrc)}" alt="Couverture">` : icon}</div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(author)}${b.volumeNumber ? " ‚Ä¢ Tome " + escapeHtml(b.volumeNumber) : ""}</p>
          <div class="actions">
            <span class="chip" data-action="obtain" data-id="${escapeHtml(b.id)}">‚úì ${escapeHtml(obtainLabel)}</span>
            <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
            <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
          </div>
        </div>
      </div>
    `;
  }

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => ([b.title, (b.authors||[]).join(" "), b.volumeNumber].join(" ").toLowerCase()).includes(query));
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);
    cards.innerHTML = filtered.length ? filtered.map(renderCard).join("") : `<div class="empty">Aucun livre ici.</div>`;
    bindCards(cards, obtainLabel);
  }
  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderPAL(){
  const root = document.getElementById("view-pal");
  const books = (booksCache || []).filter(b => b.acquired && !b.read);

  root.innerHTML = `
    ${brandCenter("PAL (√† lire)")}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${svgReader("small")} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${svgHeart("small")} Wishlist</button>
      <button class="btn" onclick="show('wattpad')">${svgPen("small")} Wattpad</button>
      <button class="btn" onclick="show('read')">${svgClosedBook("small")} Livres Lus</button>
    </div>
    <div class="panel">
      <h2><span>PAL</span><span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="created">Tri : r√©cent</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    created:(a,b)=>(b.createdAt||0)-(a.createdAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function renderCard(b){
    const icon = formatIconFallback(b);
    const coverSrc = b.coverUrl || "";
    const author = toAuthorsDisplay(b.authors);
    return `
      <div class="card" data-open="${escapeHtml(b.id)}">
        <div class="cover">${coverSrc ? `<img src="${escapeHtml(coverSrc)}" alt="Couverture">` : icon}</div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(author)}${b.volumeNumber ? " ‚Ä¢ Tome " + escapeHtml(b.volumeNumber) : ""}</p>
          <div class="actions">
            <span class="chip" data-action="read" data-id="${escapeHtml(b.id)}">‚úì Lu</span>
            <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
            <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
          </div>
        </div>
      </div>
    `;
  }

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => ([b.title, (b.authors||[]).join(" "), b.volumeNumber].join(" ").toLowerCase()).includes(query));
    }
    filtered.sort(sorter[sortSel.value] || sorter.created);
    cards.innerHTML = filtered.length ? filtered.map(renderCard).join("") : `<div class="empty">PAL vide.</div>`;
    bindCards(cards);
  }
  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderRead(){
  const root = document.getElementById("view-read");
  const books = (booksCache || []).filter(b => b.read);

  root.innerHTML = `
    ${brandCenter("Livres Lus")}
    <div class="row" style="justify-content:center; margin-bottom:6px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
      <button class="btn danger" id="clear">Vider</button>
    </div>
    <div class="panel">
      <h2><span>Livres Lus</span><span style="color:rgba(255,255,255,.78);font-size:12px;font-weight:900">${books.length} livre(s)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="q" placeholder="Rechercher (titre, auteur‚Ä¶)" />
          <select id="sort">
            <option value="readAt">Tri : lu r√©cemment</option>
            <option value="author">Tri : auteur</option>
            <option value="title">Tri : titre</option>
          </select>
        </div>
      </div>
      <div id="cards" class="list"></div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  const q = root.querySelector("#q");
  const sortSel = root.querySelector("#sort");
  const cards = root.querySelector("#cards");

  const sorter = {
    readAt:(a,b)=>(b.readAt||0)-(a.readAt||0),
    author:(a,b)=> ( (a.authors?.[0]||"").localeCompare(b.authors?.[0]||"", "fr") || (a.title||"").localeCompare(b.title||"", "fr") ),
    title:(a,b)=> ( (a.title||"").localeCompare(b.title||"", "fr") )
  };

  function renderCard(b){
    const icon = formatIconFallback(b);
    const coverSrc = b.coverUrl || "";
    const author = toAuthorsDisplay(b.authors);
    const fmt = formatFormatLabel(b);
    return `
      <div class="card" data-open="${escapeHtml(b.id)}">
        <div class="cover">${coverSrc ? `<img src="${escapeHtml(coverSrc)}" alt="Couverture">` : icon}</div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(author)}${b.volumeNumber ? " ‚Ä¢ Tome " + escapeHtml(b.volumeNumber) : ""}</p>
          <div class="actions">
            <span class="chip">${escapeHtml(fmt)}</span>
            <a class="chip" href="${amazonSearchUrl(b)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
            <span class="chip danger" data-action="delete" data-id="${escapeHtml(b.id)}">üóë Supprimer</span>
          </div>
        </div>
      </div>
    `;
  }

  function apply(){
    const query = (q.value||"").trim().toLowerCase();
    let filtered = books.slice();
    if(query){
      filtered = filtered.filter(b => ([b.title, (b.authors||[]).join(" "), b.volumeNumber].join(" ").toLowerCase()).includes(query));
    }
    filtered.sort(sorter[sortSel.value] || sorter.readAt);
    cards.innerHTML = filtered.length ? filtered.map(renderCard).join("") : `<div class="empty">Aucun livre lu pour l‚Äôinstant.</div>`;
    bindCards(cards);
  }

  root.querySelector("#clear").onclick = async ()=>{
    if(!confirm("Vider Livres Lus ?")) return;
    const toDelete = booksCache.filter(b => b.read);
    for(const b of toDelete){
      await window.BBS_CLOUD.deleteBook(b);
    }
    await window.BBS_CLOUD.reloadBooks();
    show("read");
  };

  q.addEventListener("input", apply);
  sortSel.addEventListener("change", apply);
  apply();
}

function renderAdd(){
  const root = document.getElementById("view-add");

  root.innerHTML = `
    ${brandCenter("Ajouter")}
    <div class="row" style="justify-content:center; margin-bottom:10px">
      <button class="btn" id="btnBack">‚Üê Retour</button>
      <button class="btn" onclick="show('ebooks')">${svgReader("small")} Ebooks</button>
      <button class="btn" onclick="show('wishlist')">${svgHeart("small")} Wishlist</button>
      <button class="btn" onclick="show('wattpad')">${svgPen("small")} Wattpad</button>
      <button class="btn" onclick="show('pal')">${svgOpenBook("small")} PAL</button>
    </div>

    <div class="panel">
      <h2><span>Recherche automatique (Google Books + Open Library)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="searchQuery" placeholder="Titre, auteur ou ISBN (ex: 978‚Ä¶)" />
          <button class="btn" id="searchBtn">Rechercher</button>
          <select id="formatPick">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
            <option value="wattpad">Wattpad</option>
          </select>
        </div>
        <div class="hint">Tu peux ajouter plusieurs livres sans que la page se r√©initialise.</div>
      </div>
      <div class="content">
        <div id="searchStatus" class="hint"></div>
        <div id="searchResults" class="list"></div>
      </div>
    </div>

    <div class="panel">
      <h2><span>Ajout manuel (Titre, Auteur, Tome + Galerie)</span></h2>
      <div class="content">
        <div class="row">
          <input class="input" id="mTitle" placeholder="Titre" />
          <input class="input" id="mAuthor" placeholder="Auteur" />
        </div>
        <div class="row">
          <input class="input" id="mVolume" placeholder="Tome n¬∞ (optionnel)" />
          <select id="mFormat">
            <option value="ebook">Ebook</option>
            <option value="wishlist">Wishlist</option>
            <option value="wattpad">Wattpad</option>
          </select>
        </div>
        <div class="row">
          <input class="input" id="mCoverFile" type="file" accept="image/*" />
        </div>
        <div class="hint">La couverture est compress√©e automatiquement puis upload√©e dans Firebase Storage.</div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addManual">Ajouter</button>
          <button class="btn" id="resetManual">R√©initialiser</button>
        </div>
      </div>
    </div>
  `;

  root.querySelector("#btnBack").onclick = backToHome;

  // Auto search
  const q = root.querySelector("#searchQuery");
  const btn = root.querySelector("#searchBtn");
  const status = root.querySelector("#searchStatus");
  const results = root.querySelector("#searchResults");
  const formatPick = root.querySelector("#formatPick");

  btn.addEventListener("click", ()=> doSearch());
  q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();
  window.__ADDED_PREVIEW_IDS = window.__ADDED_PREVIEW_IDS || new Set();

  async function doSearch(){
    const raw = (q.value||"").trim();
    if(!raw){
      status.textContent = "Tape un titre/auteur/ISBN puis lance la recherche.";
      results.innerHTML = "";
      return;
    }
    status.textContent = "Recherche en cours‚Ä¶";
    results.innerHTML = "";

    try{
      const google = await searchGoogleBooks(raw);
      if(google.length){
        status.textContent = `R√©sultats (Google Books) : ${google.length}`;
        results.innerHTML = google.map(renderSearchCard).join("");
        bindSearchButtons(results, formatPick, status);
        return;
      }
    }catch{}

    try{
      const ol = await searchOpenLibrary(raw);
      if(ol.length){
        status.textContent = `R√©sultats (Open Library) : ${ol.length}`;
        results.innerHTML = ol.map(renderSearchCard).join("");
        bindSearchButtons(results, formatPick, status);
        return;
      }
    }catch{}

    status.textContent = "Aucun r√©sultat. Essaie titre + auteur, ou un ISBN.";
  }

  function renderSearchCard(b){
    const already = window.__ADDED_PREVIEW_IDS.has(b._previewId);
    return `
      <div class="card">
        <div class="cover">
          ${b.coverUrl ? `<img src="${escapeHtml(b.coverUrl)}" alt="Couverture">` : "Ôºã"}
        </div>
        <div class="meta">
          <p class="t">${escapeHtml(b.title || "Sans titre")}</p>
          <p class="a">${escapeHtml(toAuthorsDisplay(b.authors))}</p>
          <div class="actions">
            <span class="chip ${already ? "disabled" : ""}" data-action="add" data-id="${escapeHtml(b._previewId)}">${already ? "Ajout√© ‚úÖ" : "‚ûï Ajouter"}</span>
            <a class="chip" href="${amazonSearchUrl({title:b.title,authors:b.authors})}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Amazon</a>
          </div>
        </div>
      </div>
    `;
  }

  function bindSearchButtons(container, formatPickEl, statusEl){
    container.querySelectorAll('[data-action="add"]').forEach(el=>{
      el.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const pid = el.dataset.id;
        if(window.__ADDED_PREVIEW_IDS.has(pid)) return;

        const meta = window.__SEARCH_CACHE.get(pid);
        if(!meta) return;

        const book = makeBook({
          title: meta.title,
          authors: meta.authors,
          volumeNumber: "",
          format: formatPickEl.value,
          coverUrl: meta.coverUrl || ""
        });

        await window.BBS_CLOUD.upsertBook(book);
        await window.BBS_CLOUD.reloadBooks({ silent:true }); // ‚úÖ ne reset pas la page

        window.__ADDED_PREVIEW_IDS.add(pid);
        el.textContent = "Ajout√© ‚úÖ";
        el.classList.add("disabled");

        statusEl.textContent = "Ajout√© ‚úÖ (tu peux continuer)";
      });
    });
  }

  // Manual add
  root.querySelector("#addManual").addEventListener("click", async ()=>{
    const title = root.querySelector("#mTitle").value.trim();
    const author = root.querySelector("#mAuthor").value.trim();
    const volumeNumber = root.querySelector("#mVolume").value.trim();
    const format = root.querySelector("#mFormat").value;
    const coverFile = root.querySelector("#mCoverFile").files?.[0] || null;

    if(!title){ alert("Titre obligatoire."); return; }
    if(!author){ alert("Auteur obligatoire."); return; }
    if(!coverFile){ alert("Ajoute une couverture depuis ta galerie."); return; }

    const book = makeBook({
      title,
      authors: [author],
      volumeNumber,
      format,
      coverUrl: ""
    });

    const upload = await window.BBS_CLOUD.uploadCover(book.id, coverFile);
    if(!upload?.url){
      alert("Erreur upload couverture (Storage). V√©rifie Storage + r√®gles.");
      return;
    }
    book.coverUrl = upload.url;
    book.coverStoragePath = upload.path;

    await window.BBS_CLOUD.upsertBook(book);
    await window.BBS_CLOUD.reloadBooks({ silent:true }); // ‚úÖ pas de reset de page

    root.querySelector("#resetManual").click();
    alert("Ajout√© ‚úÖ");
  });

  root.querySelector("#resetManual").addEventListener("click", ()=>{
    ["mTitle","mAuthor","mVolume"].forEach(id => root.querySelector("#"+id).value = "");
    root.querySelector("#mFormat").value = "ebook";
    root.querySelector("#mCoverFile").value = "";
  });
}

function makeBook({title, authors, volumeNumber, format, coverUrl}){
  return {
    id: uid(),
    title: title || "Sans titre",
    authors: authors || [],
    volumeNumber: volumeNumber || "",
    format: format || "ebook",     // ebook | wishlist | wattpad
    acquired: false,               // true => PAL
    read: false,                   // true => Livres Lus
    coverUrl: coverUrl || "",
    coverStoragePath: "",
    createdAt: Date.now(),
    readAt: null
  };
}

/* ===== Cards actions ===== */
function bindCards(container, obtainLabelOverride){
  container.querySelectorAll('[data-action="obtain"]').forEach(el=>{
    el.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = (booksCache || []).find(b => b.id === id);
      if(!book) return;
      book.acquired = true;
      await window.BBS_CLOUD.upsertBook(book);
      await window.BBS_CLOUD.reloadBooks();
      show("pal");
    });
  });

  container.querySelectorAll('[data-action="read"]').forEach(el=>{
    el.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = (booksCache || []).find(b => b.id === id);
      if(!book) return;
      book.read = true;
      book.readAt = Date.now();
      await window.BBS_CLOUD.upsertBook(book);
      await window.BBS_CLOUD.reloadBooks();
      show("read");
    });
  });

  container.querySelectorAll('[data-action="delete"]').forEach(el=>{
    el.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const id = el.dataset.id;
      const book = (booksCache || []).find(b => b.id === id);
      if(!book) return;
      if(!confirm("Supprimer ce livre ?")) return;
      await window.BBS_CLOUD.deleteBook(book);
      await window.BBS_CLOUD.reloadBooks();
      rerenderCurrent();
    });
  });

  container.querySelectorAll("[data-open]").forEach(card=>{
    card.addEventListener("click", ()=> openModal(card.dataset.open));
  });
}

/* ===== Modal ===== */
function openModal(id){
  const book = (booksCache || []).find(b => b.id === id);
  if(!book) return;

  document.getElementById("modalTitle").textContent = book.title || "Sans titre";
  document.getElementById("modalAuthor").textContent = toAuthorsDisplay(book.authors);

  const cover = document.getElementById("modalCover");
  const coverSrc = book.coverUrl || "";
  cover.innerHTML = coverSrc
    ? `<img src="${escapeHtml(coverSrc)}" alt="Couverture">`
    : `<div style="display:grid;place-items:center;height:100%;color:rgba(255,255,255,.35);font-weight:900;font-size:40px">${formatIconFallback(book)}</div>`;

  document.getElementById("modalDesc").textContent = "‚Äî";
  document.getElementById("modalBadges").innerHTML = `
    <span class="chip">${escapeHtml(formatFormatLabel(book))}</span>
    ${book.volumeNumber ? `<span class="chip">Tome ${escapeHtml(book.volumeNumber)}</span>` : ""}
    ${book.acquired ? `<span class="chip">PAL</span>` : `<span class="chip">√Ä obtenir</span>`}
    ${book.read ? `<span class="chip">Lu</span>` : ``}
  `;
  document.getElementById("modalAmazon").href = amazonSearchUrl(book);

  const fileInput = document.getElementById("modalCoverFile");
  fileInput.value = "";
  fileInput.onchange = async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;

    const upload = await window.BBS_CLOUD.uploadCover(book.id, file);
    if(!upload?.url){
      alert("Erreur upload couverture (Storage). V√©rifie Storage + r√®gles.");
      return;
    }

    if(book.coverStoragePath && book.coverStoragePath !== upload.path){
      await window.BBS_CLOUD.deleteCoverByPath(book.coverStoragePath);
    }

    book.coverUrl = upload.url;
    book.coverStoragePath = upload.path;

    await window.BBS_CLOUD.upsertBook(book);
    await window.BBS_CLOUD.reloadBooks();
    openModal(id);
  };

  document.getElementById("modalRemoveCover").onclick = async ()=>{
    if(!book.coverUrl){ alert("Aucune couverture √† retirer."); return; }
    if(!confirm("Retirer la couverture ?")) return;

    if(book.coverStoragePath){
      await window.BBS_CLOUD.deleteCoverByPath(book.coverStoragePath);
      book.coverStoragePath = "";
    }
    book.coverUrl = "";

    await window.BBS_CLOUD.upsertBook(book);
    await window.BBS_CLOUD.reloadBooks();
    openModal(id);
  };

  document.getElementById("modalDelete").onclick = async ()=>{
    if(!confirm("Supprimer ce livre ?")) return;
    await window.BBS_CLOUD.deleteBook(book);
    await window.BBS_CLOUD.reloadBooks();
    closeModal();
    rerenderCurrent();
  };

  document.getElementById("modalBackdrop").style.display = "flex";
}
function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
  if(e.target.id === "modalBackdrop") closeModal();
});

/* ===== External search ===== */
async function searchGoogleBooks(query){
  const url = new URL("https://www.googleapis.com/books/v1/volumes");
  url.searchParams.set("q", query);
  url.searchParams.set("maxResults", "20");
  url.searchParams.set("printType", "books");
  url.searchParams.set("orderBy", "relevance");

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("Google Books HTTP " + res.status);
  const data = await res.json();
  const items = data.items || [];
  const out = [];
  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();
  window.__ADDED_PREVIEW_IDS = window.__ADDED_PREVIEW_IDS || new Set();

  for(const it of items){
    const v = it.volumeInfo || {};
    const previewId = uid();
    const meta = {
      _previewId: previewId,
      title: v.title || "",
      authors: v.authors || [],
      coverUrl: normalizeCover(pickGoogleCover(v.imageLinks))
    };
    window.__SEARCH_CACHE.set(previewId, meta);
    out.push(meta);
  }
  return out;
}
function pickGoogleCover(imageLinks){
  if(!imageLinks) return "";
  return imageLinks.thumbnail || imageLinks.smallThumbnail || imageLinks.small || imageLinks.medium || imageLinks.large || "";
}
function normalizeCover(url){
  if(!url) return "";
  let u = String(url).replace("http://", "https://");
  u = u.replace(/zoom=\d/g, "zoom=2");
  return u;
}
async function searchOpenLibrary(query){
  const url = new URL("https://openlibrary.org/search.json");
  url.searchParams.set("q", query);
  url.searchParams.set("limit", "20");
  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("OpenLibrary HTTP " + res.status);
  const data = await res.json();
  const docs = data.docs || [];
  const out = [];
  window.__SEARCH_CACHE = window.__SEARCH_CACHE || new Map();
  window.__ADDED_PREVIEW_IDS = window.__ADDED_PREVIEW_IDS || new Set();

  for(const d of docs){
    const previewId = uid();
    const meta = {
      _previewId: previewId,
      title: d.title || "",
      authors: d.author_name ? d.author_name.slice(0,3) : [],
      coverUrl: d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-M.jpg` : ""
    };
    window.__SEARCH_CACHE.set(previewId, meta);
    out.push(meta);
  }
  return out;
}

// expose globals for firebase module
Object.defineProperty(window, "booksCache", { get(){ return booksCache; }, set(v){ booksCache = Array.isArray(v) ? v : []; } });
Object.defineProperty(window, "authUser", { get(){ return authUser; }, set(v){ authUser = v; } });

// start UI
show("login");
</script>

<!-- =========================
     FIREBASE (Cloud)
     ========================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    setPersistence,
    browserLocalPersistence,
    updateProfile,
    signOut as fbSignOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    deleteDoc,
    enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

  // ‚úÖ TON CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyBP7qg9V9fZE6tdAJN93yXX7tRyij75EUU",
    authDomain: "booksbysiana.firebaseapp.com",
    projectId: "booksbysiana",
    storageBucket: "booksbysiana.firebasestorage.app",
    messagingSenderId: "948417171584",
    appId: "1:948417171584:web:2bd0d48eadddccb7c11665"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ‚úÖ Storage : on force gs://bucket
  const storage = getStorage(app, `gs://${firebaseConfig.storageBucket}`);

  try { await enableIndexedDbPersistence(db); } catch {}
  await setPersistence(auth, browserLocalPersistence);

  const SALT = "BBS_2025";
  function loginEmail(username){ return `${username}@bbs.local`; }
  function loginPassword(pin){ return `${String(pin)}_${SALT}`; }

  async function signInOrCreate(username, pin){
    const email = loginEmail(username);
    const password = loginPassword(pin);

    try{
      const cred = await signInWithEmailAndPassword(auth, email, password);
      if(!auth.currentUser.displayName){
        await updateProfile(auth.currentUser, { displayName: username });
      }
      return cred;
    }catch{
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(auth.currentUser, { displayName: username });
      return cred;
    }
  }

  async function loadBooks(){
    if(!auth.currentUser) return [];
    const uid = auth.currentUser.uid;
    const snap = await getDocs(collection(db, `users/${uid}/books`));
    const books = [];
    snap.forEach(d => books.push(d.data()));
    books.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    return books;
  }

  // ‚úÖ reloadBooks avec mode silent pour √©viter reset de la page "Ajouter"
  async function reloadBooks(opts = {}){
    const { silent = false } = opts;

    const cloud = await loadBooks();
    window.booksCache = cloud;

    try{
      localStorage.setItem("bbs_local_cache_v1", JSON.stringify({ books: cloud, savedAt: Date.now() }));
    }catch{}

    if(!silent){
      window.rerenderCurrent?.();
    }
  }

  async function upsertBook(book){
    const uid = auth.currentUser.uid;
    await setDoc(doc(db, `users/${uid}/books/${book.id}`), book, { merge:true });
  }

  async function deleteBook(book){
    const uid = auth.currentUser.uid;

    if(book.coverStoragePath){
      try{ await deleteObject(ref(storage, book.coverStoragePath)); }catch{}
    }
    await deleteDoc(doc(db, `users/${uid}/books/${book.id}`));
  }

  // ‚úÖ Compression images avant upload
  async function compressImageToJpegBlob(file, maxWidth = 900, quality = 0.82) {
    let bitmap;
    if ("createImageBitmap" in window) {
      bitmap = await createImageBitmap(file);
    } else {
      bitmap = await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    const srcW = bitmap.width;
    const srcH = bitmap.height;

    const scale = Math.min(1, maxWidth / srcW);
    const dstW = Math.max(1, Math.round(srcW * scale));
    const dstH = Math.max(1, Math.round(srcH * scale));

    const canvas = document.createElement("canvas");
    canvas.width = dstW;
    canvas.height = dstH;

    const ctx = canvas.getContext("2d", { alpha: false });
    ctx.drawImage(bitmap, 0, 0, dstW, dstH);

    if (bitmap && typeof bitmap.close === "function") bitmap.close();

    const blob = await new Promise((resolve) => {
      canvas.toBlob((b) => resolve(b), "image/jpeg", quality);
    });

    if (!blob) throw new Error("Compression impossible (toBlob a √©chou√©).");
    return blob;
  }

  async function uploadCover(bookId, file){
    const uid = auth.currentUser.uid;
    const path = `users/${uid}/covers/${bookId}.jpg`;
    const r = ref(storage, path);

    const jpegBlob = await compressImageToJpegBlob(file, 900, 0.82);

    await uploadBytes(r, jpegBlob, {
      contentType: "image/jpeg",
      cacheControl: "public,max-age=31536000"
    });

    const url = await getDownloadURL(r);
    return { url, path };
  }

  async function deleteCoverByPath(path){
    if(!path) return;
    try{ await deleteObject(ref(storage, path)); }catch{}
  }

  async function signOut(){
    await fbSignOut(auth);
  }

  window.BBS_CLOUD = {
    signInOrCreate,
    reloadBooks,
    upsertBook,
    deleteBook,
    uploadCover,
    deleteCoverByPath,
    signOut
  };

  onAuthStateChanged(auth, async (user)=>{
    window.authUser = user || null;
    if(user){
      await reloadBooks();
      window.show?.("home");
    }else{
      const fallback = (function(){
        try{
          const raw = localStorage.getItem("bbs_local_cache_v1");
          if(!raw) return [];
          const p = JSON.parse(raw);
          return Array.isArray(p?.books) ? p.books : [];
        }catch{ return []; }
      })();
      window.booksCache = fallback;
      window.show?.("login");
    }
  });
</script>
</body>
</html>
